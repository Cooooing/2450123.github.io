---
layout: post
title: BitTorrent协议
date: 2024-10-12 11:24:13
tags:
  - java
  - Bencode编码
  - BitTorrent
  - p2p
categories:
  - 编程记录
---

## BitTorrent协议

BitTorrent 是一种用于分发文件的协议。它通过 URL 识别内容，旨在与 Web 无缝集成。
与普通 HTTP 相比，它的优势在于，当同一文件的多个下载同时发生时，下载器会相互上传，使得文件源可以支持非常大量的下载器，而其负载仅适度增加。

## BitTorrent协议的元素

* 普通的网络服务器
* 静态“元信息”文件（metainfo）
* BitTorrent 跟踪器（tracker）
* 一个“原始”下载器
* 最终用户网络浏览器
* 最终用户下载者

## 服务器启动流程

1. 开始运行跟踪器（或者，更有可能已经运行了一个）。
2. 开始运行一个普通的 Web 服务器，例如 apache，或者已经有一个。
3. 将扩展名 .torrent 与他们 Web 服务器上的 mimetype application/x-bittorrent 相关联（或者已经这样做了）。
4. 使用要提供的完整文件和跟踪器的 URL 生成元信息 (.torrent) 文件。
5. 将元信息文件放在 Web 服务器上。
6. 从其他网页链接到元信息 (.torrent) 文件。
7. 启动一个已经有完整文件（'origin'）的下载器。

## 客户端下载流程

安装 BitTorrent（或已经安装）。
浏览网页。
单击指向 .torrent 文件的链接。
选择在本地保存文件的位置，或选择部分下载以恢复。
等待下载完成。
告诉下载器退出（它会一直上传，直到发生这种情况）。

## bencoding

上一篇中有详细介绍，这里简述。

字符串是以长度为前缀的以十为基数，后跟一个冒号和字符串。例如 `4:spam` 对应于 `'spam'`。
整数由“i”表示，后跟以 10 为底的数字，后跟“e”。例如，`i3e` 对应于 `3`。 **含义：int 整数 end**
列表被编码为“l”，后跟其元素（也被编码），后跟“e”。例如 `l4:spam4:eggse` 对应于 `['spam', 'eggs']` **含义：list 列表 end**
字典被编码为一个“d”，后跟一个交替键列表和它们的对应值，后跟一个“e”。例如，`d3:cow3:moo4:spam4:eggse` 对应于
`{'cow': 'moo', 'spam': 'eggs'}` **含义：dictionary 字典 end**。键必须是字符串并按排序顺序显示（按原始字符串排序，而不是字母数字）。

## 元数据文件（种子文件） metainfo files（.torrent)

元信息文件（也称为 .torrent 文件）是具有以下键的编码字典：

* announce: 跟踪器的 URL。
* info: 这映射到一个字典，键如下所述。
    * name key映射到 UTF-8 编码的字符串，这是保存文件（或目录）的建议名称。这纯粹是建议性的。
    * 片段（pieces）长度映射到文件被分成的每个片段中的字节数。为了传输的目的，文件被分成固定大小的片段，除了可能被截断的最后一个片段之外，这些片段的长度都相同。片段长度几乎总是
      2 的幂，最常见的是 2^18 = 256 K（3.2 版之前的 BitTorrent 使用 2^20 = 1 M 作为默认值）。 片段映射到一个长度为 20
      的倍数的字符串。它将被细分为长度为 20 的字符串，每个字符串都是该片段在相应索引处的 SHA1 哈希。
    * 还有一个key length或一组key files，**但不是两者都有或两者都没有**。如果存在key length，则下载代表单个文件，否则代表目录结构中的一组文件。
        * 在单个文件的情况下，key length映射到文件的长度（以字节为单位）。
        * 对于其他keys，多文件情况被视为只有一个文件，此文件含义为将文件按照它们在文件列表中出现的顺序连接起来。文件列表是文件映射到的值，并且是包含以下键的字典列表：
            * length - 文件的长度，以字节为单位。
            * path - 与子目录名称相对应的 UTF-8 编码字符串列表，最后一个是实际文件名（零长度列表是错误情况）。

在单文件情况下，名称键是文件名，在多文件情况下，它是目录名。
.torrent 文件中包含文本的所有字符串都必须采用 UTF-8 编码。



























